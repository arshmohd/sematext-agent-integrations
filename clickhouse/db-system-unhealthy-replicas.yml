type: db
data:
  query: SELECT database, table, count(*) as unhealthy_replicas
    FROM system.replicas
    WHERE is_readonly
        OR is_session_expired
        OR future_parts > 20
        OR parts_to_check > 10
        OR queue_size > 20
        OR inserts_in_queue > 10
        OR log_max_index - log_pointer > 10
        OR total_replicas < 2
        OR active_replicas < total_replicas
    GROUP BY database, table;
  dbUrl: jdbc:clickhouse://${ST_MONITOR_CLICKHOUSE_DB_HOST_PORT}/system
  dbDriverClass: ru.yandex.clickhouse.ClickHouseDriver
  dbUser: ${ST_MONITOR_CLICKHOUSE_DB_USER}
  dbPassword: ${ST_MONITOR_CLICKHOUSE_DB_PASSWORD}

observation:
  - name: replicas
    metricNamespace: clickhouse
    metric:
      - name: database
        source: database
        type: text
        send: false
      - name: table
        source: table
        type: text
        send: false
      - name: replicas.unhealthy
        source: unhealthy_replicas
        type: long_gauge
        label: Unhealthy replicas
        description: Count of replicas of the table that have issues
    tag:
      - name: clickhouse.database
        value: eval:${database}
      - name: clickhouse.table
        value: eval:${table}